name: Deploy to Production

on:
  push:
    branches:
      - main
    paths:
      - 'sites/**'
      - 'packages/**'
  workflow_dispatch:
    inputs:
      site:
        description: 'Site to deploy (leave empty for changed sites only)'
        required: false
        type: string

jobs:
  # Run quality gates before deployment
  quality-gates:
    name: Quality Gates Check
    uses: ./.github/workflows/quality-gates.yml

  detect-changes:
    name: Detect Changed Sites
    needs: quality-gates
    runs-on: ubuntu-latest
    outputs:
      changed_sites: ${{ steps.detect.outputs.changed_sites }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed sites
        id: detect
        run: |
          if [ -n "${{ github.event.inputs.site }}" ]; then
            # Manual workflow dispatch with specific site
            CHANGED_SITES='["${{ github.event.inputs.site }}"]'
          else
            # Auto-detect from git diff
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)

            # Find unique site directories
            CHANGED_SITES=$(echo "$CHANGED_FILES" | grep '^sites/' | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n")[:-1]')

            # If packages changed, rebuild all sites
            if echo "$CHANGED_FILES" | grep -q '^packages/'; then
              CHANGED_SITES=$(ls -1 sites | jq -R -s -c 'split("\n")[:-1]')
            fi

            # If no sites detected but workflow triggered, use default site
            if [ "$CHANGED_SITES" == "[]" ] || [ -z "$CHANGED_SITES" ]; then
              CHANGED_SITES='["dws-web-ai"]'
            fi
          fi

          echo "changed_sites=$CHANGED_SITES" >> $GITHUB_OUTPUT
          echo "ðŸš€ Sites to deploy: $CHANGED_SITES"

  deploy-production:
    name: Deploy ${{ matrix.site }} to Production
    needs: detect-changes
    if: needs.detect-changes.outputs.changed_sites != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        site: ${{ fromJson(needs.detect-changes.outputs.changed_sites) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build production site
        run: pnpm --filter=${{ matrix.site }} build
        env:
          NODE_ENV: production
          SITE_URL: https://${{ matrix.site }}.com

      - name: Validate production build
        run: |
          if [ ! -d "sites/${{ matrix.site }}/dist" ]; then
            echo "âŒ Production build failed: dist directory not found"
            exit 1
          fi

          BUILD_SIZE=$(du -sh sites/${{ matrix.site }}/dist | cut -f1)
          echo "âœ… Production build successful: $BUILD_SIZE"

          # Count generated pages
          PAGE_COUNT=$(find sites/${{ matrix.site }}/dist -name "*.html" | wc -l)
          echo "ðŸ“„ Generated pages: $PAGE_COUNT"

      - name: Deploy to production
        run: |
          echo "ðŸš€ Deploying ${{ matrix.site }} to production..."
          echo "Build artifacts: sites/${{ matrix.site }}/dist"
          echo ""
          echo "âš™ï¸ Deployment Configuration:"
          echo "  - Site: ${{ matrix.site }}"
          echo "  - Environment: production"
          echo "  - Branch: main"
          echo ""
          echo "ðŸ“‹ Deployment Options:"
          echo ""
          echo "Option 1: Vercel"
          echo "  npx vercel deploy sites/${{ matrix.site }}/dist \\"
          echo "    --token=\${{ secrets.VERCEL_TOKEN }} \\"
          echo "    --prod \\"
          echo "    --yes"
          echo ""
          echo "Option 2: Netlify"
          echo "  npx netlify deploy \\"
          echo "    --dir=sites/${{ matrix.site }}/dist \\"
          echo "    --site=\${{ secrets.NETLIFY_SITE_ID }} \\"
          echo "    --auth=\${{ secrets.NETLIFY_AUTH_TOKEN }} \\"
          echo "    --prod"
          echo ""
          echo "Option 3: Custom Server (SCP/SFTP)"
          echo "  scp -r sites/${{ matrix.site }}/dist/* user@server:/var/www/${{ matrix.site }}"
          echo ""
          echo "Option 4: AWS S3"
          echo "  aws s3 sync sites/${{ matrix.site }}/dist s3://bucket-name/ --delete"
          echo ""
          echo "âš ï¸ NOTE: Actual deployment disabled in this workflow"
          echo "To enable deployment, uncomment the appropriate deployment"
          echo "command above and configure required secrets."
          echo ""
          echo "âœ… Deployment preparation complete"

      - name: Upload production artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.site }}-production-build
          path: sites/${{ matrix.site }}/dist
          retention-days: 30

      - name: Generate deployment report
        run: |
          mkdir -p deployment-reports

          cat > deployment-reports/${{ matrix.site }}-deployment.md << EOF
          # Production Deployment Report

          **Site:** ${{ matrix.site }}
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Branch:** main
          **Commit:** ${{ github.sha }}
          **Triggered by:** ${{ github.actor }}

          ## Build Information

          - Build Status: âœ… Success
          - Build Size: $(du -sh sites/${{ matrix.site }}/dist | cut -f1)
          - Pages Generated: $(find sites/${{ matrix.site }}/dist -name "*.html" | wc -l)
          - Build Time: ${{ github.run_number }}

          ## Quality Gates

          All 6 quality gates passed:
          - âœ… Code Quality
          - âœ… Build Validation
          - âœ… SEO Compliance
          - âœ… Accessibility
          - âœ… Content Quality
          - âœ… Security

          ## Deployment Status

          - Deployment Mode: Preparation (artifacts ready)
          - Artifacts: Uploaded to GitHub (30-day retention)
          - Production URL: https://${{ matrix.site }}.com (pending deployment)

          ## Next Steps

          1. Configure deployment platform (Vercel/Netlify/Custom)
          2. Add platform secrets to GitHub repository
          3. Update workflow to enable actual deployment
          4. Monitor production site after go-live

          ## Files Changed

          \`\`\`
          $(git diff --name-only HEAD^ HEAD | grep "^sites/${{ matrix.site }}")
          \`\`\`
          EOF

          cat deployment-reports/${{ matrix.site }}-deployment.md

      - name: Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.site }}-deployment-report
          path: deployment-reports/${{ matrix.site }}-deployment.md
          retention-days: 90

  deployment-summary:
    name: Deployment Summary
    needs: [detect-changes, deploy-production]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** main" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-production.result }}" == "success" ]; then
            echo "## âœ… Deployment Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All sites deployed successfully to production." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Deployed Sites" >> $GITHUB_STEP_SUMMARY
            echo "${{ needs.detect-changes.outputs.changed_sites }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Post-Deployment Checklist" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] Verify production URLs are accessible" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] Run smoke tests on critical pages" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] Check Core Web Vitals in Google Search Console" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] Monitor error rates in analytics" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] Notify client of successful deployment" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Deployment Status: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Production deployment encountered errors." >> $GITHUB_STEP_SUMMARY
            echo "Review workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Build Artifacts:** Available in workflow artifacts (30-day retention)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ **Deployment Report:** Available in workflow artifacts (90-day retention)" >> $GITHUB_STEP_SUMMARY
